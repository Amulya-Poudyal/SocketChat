<!DOCTYPE html>
<html>
<head>
    <title>Chat - Chat App</title>
    <style>
        body { 
            font-family: Arial; 
            background:#121212; 
            color:#eee; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            height:100vh; 
        }
        .container { 
            width:400px; 
            background:#1e1e1e; 
            border-radius:8px; 
            box-shadow:0 0 20px rgba(0,0,0,0.5); 
            padding:20px; 
        }
        #messages { 
            height:300px; 
            overflow-y:auto; 
            border:1px solid #333; 
            padding:10px; 
            margin-bottom:10px; 
            background:#2c2c2c; 
            border-radius:5px;
        }
        .message { margin-bottom:5px; }
        .username { font-weight:bold; color:#bb86fc; }
        .timestamp { font-size:0.8em; color:#aaa; margin-left:5px; }
        input { width:80%; padding:8px; border-radius:5px; border:none; background:#2c2c2c; color:#eee; }
        button { width:18%; padding:8px; background:#bb86fc; color:#121212; border:none; cursor:pointer; border-radius:5px; }
        button:hover { background:#985eff; }
    </style>
</head>
<body>

<div class="container">
    <h2>Chat</h2>
    <div id="messages"></div>
    <input id="messageInput" placeholder="Type message">
    <button onclick="sendMessage()">Send</button>
</div>

<script>
let ws;
let username = localStorage.getItem("username");
if (!username) location.href = "login.html";

const messagesDiv = document.getElementById("messages");

function connectWebSocket() {
    ws = new WebSocket("ws://192.168.31.198:8080");

    ws.onopen = () => {
        ws.send(JSON.stringify({ type:"auth", payload:{ username } }));
    }

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "history") data.payload.forEach(msg => appendMessage(msg));
        if (data.type === "chat") appendMessage(data.payload);
    }
}

function appendMessage(msg) {
    const div = document.createElement("div");
    div.className = "message";
    div.innerHTML = `<span class="username">${msg.username}</span>: ${msg.text} <span class="timestamp">${msg.timestamp || ""}</span>`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function sendMessage() {
    const text = document.getElementById("messageInput").value;
    if (!text) return;
    ws.send(JSON.stringify({ type:"chat", payload:{ text } }));
    document.getElementById("messageInput").value = "";
}

connectWebSocket();
</script>
</body>
</html>
